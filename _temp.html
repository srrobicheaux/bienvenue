<!DOCTYPE html>
<html>
<head>
  <title>Tesla Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: 'Courier New', monospace; background: #000; color: #0f0; text-align: center; margin: 0; padding: 20px; overflow: hidden;}
    .container {max-width: 800px; margin: 0 auto;}
    .card {background: rgba(0,20,0,0.8); padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 0 20px #0f0; border: 1px solid #0f0;}
    canvas {width: 100% !important; height: 300px !important;}
    #status {font-size: 2.5rem; font-weight: bold; margin: 20px 0; text-shadow: 0 0 10px rgb(0, 136, 255);}
    #clock, #uptime {font-size: 2rem; margin: 10px; text-shadow: 0 0 15px rgb(0, 251, 255); animation: glow 2s infinite alternate;}
    @keyframes glow {from {text-shadow: 0 0 10px rgb(0, 217, 255);} to {text-shadow: 0 0 30px rgb(8, 0, 255), 0 0 40px #0f0;}}
    .approaching {color: #0ff;} .leaving {color: #f0f;} .stationary {color: #ff0;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Tesla Tracker</h1>
    <div class="card">
      <div>Current Status: <span id="status" class="stationary">WAITING</span></div>
      <div>Current RSSI: <span id="rssi">--</span> dBm</div>
    </div>
    <div class="card">
      <div id="clock">--:--:--</div>
      <div>Uptime: <span id="uptime">0</span> seconds</div>
    </div>
    <div class="card">
      <canvas id="rssiChart"></canvas>
    </div>
  </div>

<script>
  console.log('JS loaded');
  // Live clock (24-hour)
  function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString('en-GB', {hour12: false});
    document.getElementById('clock').textContent = time;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // Uptime counter (seconds since page load - proves JS running)
  let startTime = Date.now();
  setInterval(() => {
    let uptime = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('uptime').textContent = uptime;
  }, 1000);

  // Chart.js setup
  const ctx = document.getElementById('rssiChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {labels: [], datasets: [{label: 'RSSI (dBm)', data: [], borderColor: '#0f0', backgroundColor: 'rgba(0,255,0,0.2)', tension: 0.4, fill: true, pointRadius: 0}]},
    options: {responsive: true, animation: false, scales: {y: {min: -100, max: -30, ticks: {color: '#0f0'}, grid: {color: '#030'}}, x: {ticks: {color: '#0f0'}, grid: {color: '#030'}}}, plugins: {legend: {display: false}}}
  });

  // SSE connection
  console.log('Opening EventSource');
  const evtSource = new EventSource('/events');
  evtSource.onopen = () => console.log('SSE connected');
  evtSource.onmessage = function(event) {
    console.log('SSE message:', event.data);
    if (!event.data) return;
    try {
      const data = JSON.parse(event.data);
      document.getElementById('rssi').textContent = data.rssi;
      document.getElementById('status').textContent = data.trend;
      document.getElementById('status').className = data.trend.toLowerCase();

      chart.data.labels.push(new Date().toLocaleTimeString('en-GB', {hour12: false}));
      chart.data.datasets[0].data.push(data.rssi);
      if (chart.data.labels.length > 50) {chart.data.labels.shift(); chart.data.datasets[0].data.shift();}
      chart.update();
    } catch (e) {console.error('SSE parse error:', e);}
  };
  evtSource.onerror = function() {
    console.error('SSE error');
    document.getElementById('status').textContent = 'DISCONNECTED';
    document.getElementById('status').className = '';
  };
</script>
</body>
</html>